name: Sync README.md

on:
  push:
    branches:
      - main
      - README
    paths:
      - README.md

jobs:
  sync-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Determine source and target branches
        id: branches
        run: |
          # 当前分支
          CUR_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "当前分支为：$CUR_BRANCH"
          if [ "$CUR_BRANCH" = "main" ]; then
            TARGET_BRANCH="README"
          else
            TARGET_BRANCH="main"
          fi
          echo "::set-output name=target::$TARGET_BRANCH"

      - name: Checkout target branch into a separate directory
        uses: actions/checkout@v2
        with:
          repository: ${{ github.repository }}
          ref: ${{ steps.branches.outputs.target }}
          path: target_branch

      - name: Compare README.md files
        run: |
          # 比较两个分支中的 README.md 文件内容是否一致
          diff -q README.md target_branch/README.md || echo "不同"

      - name: Synchronize README.md
        if: ${{ failure() }}  # 当 diff 检测到不同内容时
        run: |
          # 将当前分支中的 README.md 覆盖目标分支中的同名文件
          cp README.md target_branch/README.md
          cd target_branch
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "同步 README.md 文件：更新自 ${{ github.ref }}"
          git push origin HEAD:${{ steps.branches.outputs.target }}
